#!/usr/bin/env bash
set -euo pipefail

# Maximum allowed size for staged files (bytes)
max_bytes=$((5 * 1024 * 1024))
oversized=()

while IFS= read -r -d '' path; do
    size=$(git cat-file -s :"$path")
    if [ "$size" -gt "$max_bytes" ]; then
        mb=$(( (size + 1024*1024 - 1) / (1024*1024) ))
        oversized+=("$path (${mb}MB)")
    fi
done < <(git diff --cached --name-only --diff-filter=AM -z)

if [ "${#oversized[@]}" -gt 0 ]; then
    echo "Commit blocked: the following staged files exceed 10MB:"
    for entry in "${oversized[@]}"; do
        echo " - $entry"
    done
    echo "Remove these files from the commit or reduce their size, then retry."
    exit 1
fi
